<div class="index">

  <h2> Hello <%= current_user.username %> </h2>

  <div class="stats group">
    <%= render partial: 'beer_stats', locals: {beerstyles_hash: @beerstyles_hash, beerabvs_hash: @beerabvs_hash} %>
  </div>

  <div class="saved">
    <h3> Saved Beers </h3>
    <div class='saved-beers-list-container'>
      <ul>
        
        <% @saved_beers.each_with_index do |saved_beer, i| %>
        <li class="group"> 
          <div class="beer-info-and-buttons group">
          <div class="saved-beer-info"> 
            <a href="http://beeradvocate.com/beer/profile/<%= saved_beer.beerinfo.brewery_id %>/<%= saved_beer.beerinfo.beer_id %>"> <%= saved_beer.beerinfo.beer_name %></a>
            by 
            <%= saved_beer.beerinfo.brewery_name %>
          </div>
          <div class="button-container">
<!--             <%= link_to("find bars", users_url(:beer_name => saved_beer.beerinfo.beer_name, anchor: "bars"), { :id => "find-bars-link"})%> -->

          <form action="<%= create_map_url %>" method="post"  data-remote="true" class="map-form" >
            <input type="hidden" name="beer_name" value="<%= find_beer_info(saved_beer.beer_id)[1] %>"  >
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <input type="hidden" name="beer_id" value="<%= saved_beer.beer_id %>">
            <input type="submit" value="Map!">
          </form>


            <form action="<%= savedbeer_url(saved_beer.id) %>" method="post" class="delete-saved-beer">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <input type="hidden" name="_method", value="delete">
              <input type="submit" value="unsave">
            </form>

            

            <% if !@fav_beer_beer_ids.include? saved_beer.beer_id %>
              <%= render partial: 'fav_beer_button', locals: {beer: saved_beer}%>
            <% end %>
            <button class="recommend-button">Recommend me!</button>
          </div>
          </div>
          <div class="map-render" id="map-render-<%= saved_beer.beer_id %>"></div>

             <ul class="recommended-per-beer groupup">
            <% find_recommendations(saved_beer.beerinfo.beer_id)[1].each do |rec_beer| %>
              <% rec_beer_info = find_beer_info(rec_beer[0]) %>
            <li>
              <%= rec_beer_info[1] %> by <%= rec_beer_info[0] %>
            </li>
            <% end %>
          </ul>
        </li>

        <% end %>
      </ul>
    </div>
    <h4> Save another beer </h4>
    
    <form action="<%= savedbeers_url %>" method="post">
      <%= render partial: "shared/save_beer_form", locals: {beers: @allbeers}  %>
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="submit" value="Save Beer">
    </form>
  </div>

  <div class="favorited">
    <h3> Favorited Beers </h3>
    <div class='favorited-beers-list-container'>
      <ul>
        <% @favorited_beers.each do |favorited_beer| %>
        <li class="group"> <div class="favorited-beer-info"> 
          <a href="http://beeradvocate.com/beer/profile/<%= favorited_beer.beerinfo.brewery_id %>/<%= favorited_beer.beerinfo.beer_id %>"> <%= favorited_beer.beerinfo.beer_name %></a>
          by 
          <%= favorited_beer.beerinfo.brewery_name %>  </div>
          <div class="button-container">
            <%= link_to("find bars", users_url(:beer_name => favorited_beer.beerinfo.beer_name, anchor: "bars"), { :id => "find-bars-link"}) %>
            <form action="<%= favbeer_url(favorited_beer.id) %>" method="post" class="delete-favorited-beer">
             <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
             <input type="hidden" name="_method", value="delete">
            <input type="submit" value="unfavorite">
            </form>
            <% if !@saved_beer_beer_ids.include? favorited_beer.beer_id %>
              <%= render partial: 'save_beer_button', locals: {beer: favorited_beer}%>
            <% end %>
        
          </div>
        </li>

        <% end %>
      </ul>
    </div>
    <h4> Favorite another beer </h4>
    
    <form action="<%= favbeers_url %>" method="post">
      <%= render partial: "shared/favorite_beer_form", locals: {beers: @allbeers}  %>
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="submit" value="Favorite Beer">
    </form>
  </div>


<!--   <div class="recommended">
    <h3> Recommended Beers </h3>
    <div class='recommended-beers-list-container'>
      <ul>
        <% @all_rec_beers.each do |all_rec| %>
          <% 2.times do |i| %>
            <% rec = all_rec[1][i] %>
            <li> Try: <%= rec[0][1] %> by <%= rec[0][0] %> (Style: <%= rec[0][2] %>)
              <form action="<%= user_savedbeers_url(current_user.id) %>" method="post" class="save-recommended-beer">
                <input type="hidden" name="savedbeers[beer_id]" value="<%= rec[0][3] %>">
                <%= rec[0][3]  %>
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <input type="submit" value="Save">
              </form>
              <ul>
                <li> 
                  Because you enjoyed 
                  <%= all_rec[0][1] %> by <%= all_rec[0][0] %> 
                </li>
              </ul>
            </li>
          <% end %>
        <% end %>
      </ul>
    </div>
  </div> -->

  <div class="<%= params[:beer_name].nil? ? "hidden" : "bars" %>"> 
    <a name="bars"></a>
    <h3> Bars </h3>
    <p> <%= @bars.empty? ? "There are no #{params[:beer_name]} in your area" : "" %></p>
    <div class="bars-list-container <%= @bars.empty? ? "hidden" : "" %>">
      <h4>You can find <%= params[:beer_name] %> at: </h4>
        <ul>
          <% @bars.each do |bar| %>
            <li><%= bar["name"] %> at <%= bar["address"] %></li>
          <% end %>
        </ul>
        <div id='rec-map'>
        <div id='map' style="width: 400px; height: 400px;"></div>
    </div>
  </div>



</div>

<script>


  $(document).ready($(".beers-select-list").chosen())

  $(document).ready($(".recommended-per-beer").hide())

  $(document).ready($(".recommend-button").on("click", function(event) {
    $(this).parent().parent().parent().children('ul').slideToggle()
  } ))

  $(document).ready(function() {

    var geocoder = null;
    var map = null;
    var latLon = null;
    var bars = <%= raw @bars.to_json %>;

    function init(startLoc) {
      var geocoder = new google.maps.Geocoder();
      var latlng = startLoc;
      var mapOptions = {
        zoom: 10,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      map = new google.maps.Map(document.getElementById('rec-map'), mapOptions);
    }

    function codeAddress(barLoc, info) {
      var address = barLoc;
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map,
              info: info,
              position: results[0].geometry.location
          });
          var infowindow = new google.maps.InfoWindow();
          google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent('<p id="hook">' + this.info + '</p>');
            infowindow.open(map, this);
          });
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    
    function returnLatLon(address1) {
      var address = address1;
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({ 'address': address1 }, function(results, status){ 
      if (status == google.maps.GeocoderStatus.OK) {
        latLon = results[0].geometry.location;
        init(latLon);
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
      });

    };

    returnLatLon(String(<%= current_user.location %>));
    for (var i = 0; i < bars.length && i < 10; i++) {
      codeAddress(bars[i]['address'] + <%= current_user.location %>, bars[i]['name'] + '<br>' + bars[i]['address'] + '<br>' + bars[i]['phone'])
    }
    



    })

$(document).ready(function(){
  
  // Using Rails UJS, bind an event listener to the form
  // Read more about UJS Ajax events here:
  // https://github.com/rails/jquery-ujs/wiki/ajax
  $(".map-form").on("ajax:success", function(event, data){
    console.log($(this).parents('li').children(".map-render"));
    
    // We want the data passed in to be a single rendered partial.
    // That way we can easily prepend it to the container tag.
    $(this).parents('li').children(".map-render").prepend(data);
    
  });

});
  


//mapbox stuff
// var map = L.mapbox.map('map', 'jinpark.map-x0vxytgt')
//     .setView([37.9, -77], 6);

// L.mapbox.markerLayer({
//     // this feature is in the GeoJSON format: see geojson.org
//     // for the full specification
//     type: 'Feature',
//     geometry: {
//         type: 'Point',
//         // coordinates here are in longitude, latitude order because
//         // x, y is the standard for GeoJSON and many formats
//         coordinates: [-77, 37.9]
//     },
//     properties: {
//         title: 'A Single Marker',
//         description: 'Just one of me',
//         // one can customize markers by adding simplestyle properties
//         // http://mapbox.com/developers/simplestyle/
//         'marker-size': 'large',
//         'marker-color': '#f0a'
//     }
// }).addTo(map);

  


</script>